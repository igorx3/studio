{
  "entities": {
    "Order": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Order",
      "type": "object",
      "description": "Represents a delivery order.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the order."
        },
        "clientId": {
          "type": "string",
          "description": "Reference to Client. (Relationship: Client 1:N Order)"
        },
        "courierId": {
          "type": "string",
          "description": "Reference to Courier. (Relationship: Courier 1:N Order). Can be null if no courier is assigned."
        },
        "warehouseId": {
          "type": "string",
          "description": "Reference to Warehouse. (Relationship: Warehouse 1:N Order)"
        },
        "orderDate": {
          "type": "string",
          "description": "Date and time the order was placed.",
          "format": "date-time"
        },
        "deliveryAddress": {
          "type": "string",
          "description": "Delivery address for the order."
        },
        "deliveryInstructions": {
          "type": "string",
          "description": "Special delivery instructions."
        },
        "status": {
          "type": "string",
          "description": "Current status of the order (e.g., pending, in transit, delivered).",
          "format": "string"
        },
        "totalAmount": {
          "type": "number",
          "description": "Total amount of the order."
        }
      },
      "required": [
        "id",
        "clientId",
        "warehouseId",
        "orderDate",
        "deliveryAddress",
        "status",
        "totalAmount"
      ]
    },
    "Client": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Client",
      "type": "object",
      "description": "Represents a client (shop) using the delivery service.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the client."
        },
        "name": {
          "type": "string",
          "description": "Name of the client (shop)."
        },
        "email": {
          "type": "string",
          "description": "Email address of the client.",
          "format": "email"
        },
        "phone": {
          "type": "string",
          "description": "Phone number of the client."
        },
        "address": {
          "type": "string",
          "description": "Address of the client."
        },
        "walletBalance": {
          "type": "number",
          "description": "Current wallet balance of the client."
        }
      },
      "required": [
        "id",
        "name",
        "email",
        "phone",
        "address",
        "walletBalance"
      ]
    },
    "Courier": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Courier",
      "type": "object",
      "description": "Represents a courier.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the courier."
        },
        "name": {
          "type": "string",
          "description": "Name of the courier."
        },
        "phone": {
          "type": "string",
          "description": "Phone number of the courier."
        },
        "vehicleType": {
          "type": "string",
          "description": "Type of vehicle the courier uses (e.g., motorcycle, car)."
        },
        "currentLocation": {
          "type": "string",
          "description": "Current location of the courier (e.g., GPS coordinates)."
        },
        "isAvailable": {
          "type": "boolean",
          "description": "Indicates if the courier is currently available for assignments."
        }
      },
      "required": [
        "id",
        "name",
        "phone",
        "vehicleType",
        "isAvailable"
      ]
    },
    "Warehouse": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Warehouse",
      "type": "object",
      "description": "Represents a warehouse.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the warehouse."
        },
        "name": {
          "type": "string",
          "description": "Name of the warehouse."
        },
        "address": {
          "type": "string",
          "description": "Address of the warehouse."
        },
        "capacity": {
          "type": "number",
          "description": "Maximum storage capacity of the warehouse."
        }
      },
      "required": [
        "id",
        "name",
        "address",
        "capacity"
      ]
    },
    "Settlement": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Settlement",
      "type": "object",
      "description": "Represents a financial settlement for a courier.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the settlement."
        },
        "courierId": {
          "type": "string",
          "description": "Reference to Courier. (Relationship: Courier 1:N Settlement)"
        },
        "settlementDate": {
          "type": "string",
          "description": "Date of the settlement.",
          "format": "date-time"
        },
        "amount": {
          "type": "number",
          "description": "Amount paid to the courier."
        },
        "orderIds": {
          "type": "array",
          "description": "References to Orders included in this settlement. (Relationship: Order N:N Settlement).",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "courierId",
        "settlementDate",
        "amount",
        "orderIds"
      ]
    },
    "RouteOptimizationRequest": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "RouteOptimizationRequest",
      "type": "object",
      "description": "Represents a route optimization request submitted to the AI tool.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the route optimization request."
        },
        "orderIds": {
          "type": "array",
          "description": "References to Orders to be included in the route optimization.",
          "items": {
            "type": "string"
          }
        },
        "courierId": {
          "type": "string",
          "description": "Reference to Courier for whom the route is being optimized. (Relationship: Courier 1:N RouteOptimizationRequest)"
        },
        "requestTime": {
          "type": "string",
          "description": "Date and time the route optimization was requested.",
          "format": "date-time"
        },
        "optimizedRouteData": {
          "type": "string",
          "description": "The optimized route data, possibly in a serialized format (e.g., JSON string)."
        }
      },
      "required": [
        "id",
        "orderIds",
        "courierId",
        "requestTime",
        "optimizedRouteData"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/clients/{clientId}",
        "definition": {
          "entityName": "Client",
          "schema": {
            "$ref": "#/backend/entities/Client"
          },
          "description": "Stores client data. Secure reads/writes based on the authenticated user ID matching the clientId.",
          "params": [
            {
              "name": "clientId",
              "description": "The unique identifier of the client."
            }
          ]
        }
      },
      {
        "path": "/clients/{clientId}/orders/{orderId}",
        "definition": {
          "entityName": "Order",
          "schema": {
            "$ref": "#/backend/entities/Order"
          },
          "description": "Stores orders associated with a specific client.  Secure reads/writes based on the authenticated user ID matching the clientId in the path.",
          "params": [
            {
              "name": "clientId",
              "description": "The unique identifier of the client."
            },
            {
              "name": "orderId",
              "description": "The unique identifier of the order."
            }
          ]
        }
      },
      {
        "path": "/couriers/{courierId}",
        "definition": {
          "entityName": "Courier",
          "schema": {
            "$ref": "#/backend/entities/Courier"
          },
          "description": "Stores courier data. Secure reads/writes based on the authenticated user ID matching the courierId.",
          "params": [
            {
              "name": "courierId",
              "description": "The unique identifier of the courier."
            }
          ]
        }
      },
      {
        "path": "/warehouses/{warehouseId}",
        "definition": {
          "entityName": "Warehouse",
          "schema": {
            "$ref": "#/backend/entities/Warehouse"
          },
          "description": "Stores warehouse data. Access controlled based on role-based authentication (e.g., only admins or warehouse personnel can access).",
          "params": [
            {
              "name": "warehouseId",
              "description": "The unique identifier of the warehouse."
            }
          ]
        }
      },
      {
        "path": "/couriers/{courierId}/settlements/{settlementId}",
        "definition": {
          "entityName": "Settlement",
          "schema": {
            "$ref": "#/backend/entities/Settlement"
          },
          "description": "Stores settlement data for a specific courier. Secure reads/writes based on the authenticated user ID matching the courierId in the path.",
          "params": [
            {
              "name": "courierId",
              "description": "The unique identifier of the courier."
            },
            {
              "name": "settlementId",
              "description": "The unique identifier of the settlement."
            }
          ]
        }
      },
      {
        "path": "/couriers/{courierId}/routeOptimizationRequests/{routeOptimizationRequestId}",
        "definition": {
          "entityName": "RouteOptimizationRequest",
          "schema": {
            "$ref": "#/backend/entities/RouteOptimizationRequest"
          },
          "description": "Stores route optimization requests for a specific courier. Secure reads/writes based on the authenticated user ID matching the courierId in the path.",
          "params": [
            {
              "name": "courierId",
              "description": "The unique identifier of the courier."
            },
            {
              "name": "routeOptimizationRequestId",
              "description": "The unique identifier of the route optimization request."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support the core features of the KhlothiaPack application, including order management, courier management, financial reconciliation, warehouse management, and route optimization. The structure prioritizes authorization independence by denormalizing authorization data where necessary, ensuring that security rules can be written without complex `get()` calls. This approach enhances security, scalability, and debuggability. Furthermore, Structural Segregation ensures that each collection houses documents with similar security postures.\n\n**Authorization Independence and QAPs:**\n\n*   **Clients:** Client data is stored under `/clients/{clientId}` ensuring that clients can only access their data using Firebase Authentication. This path-based authorization eliminates the need for complex rules.\n*   **Couriers:** Courier data is stored under `/couriers/{courierId}`, similar to Clients, enabling straightforward courier-specific access control.\n*   **Orders:** Orders are stored under `/clients/{clientId}/orders/{orderId}`. This structure facilitates secure listing of orders per client. The `clientId` is used in the path, making authorization independent and QAP-compliant for client-specific order access.\n*   **Warehouses:** Warehouse data is stored under `/warehouses/{warehouseId}` with similar straightforward access control.\n*   **Settlements:** Settlements are stored under `/couriers/{courierId}/settlements/{settlementId}`.  The `courierId` is part of the path, making authorization independent and QAP-compliant.  This structure simplifies access control for settlements related to specific couriers.\n*   **Route Optimization Requests:** Route optimization requests are stored under `/couriers/{courierId}/routeOptimizationRequests/{routeOptimizationRequestId}`. This structure enforces the relationship between a courier and their route optimization requests, facilitating simpler and more secure rules.\n\nThis design ensures that list operations (`QAPs`) are secure, as access is controlled via path-based authorization or denormalized membership maps.  Authorization independence is achieved by avoiding `get()` calls in rules, enabling atomic operations and easier debugging."
  }
}